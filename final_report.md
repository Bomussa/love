# تقرير ربط الواجهة الأمامية والخلفية وتحقيق نظام الدور الديناميكي

## مقدمة
بعد استعادة بنية المشروع الأصلية للتطبيق الطبي وإعادة تفعيل جميع الملفات الضرورية، يتطلب الأمر ربط الواجهة الأمامية مع الخلفية بحيث يعمل النظام بصورة متكاملة وسلسة دون أخطاء. هذا التقرير يوضح آلية تنفيذ المميزات الخمس المطلوبة (الإحصائيات والتقارير، نظام الدور "الكيو"، نظام الإشعارات، نظام المسارات الديناميكية، ونظام البن‑كود)، مع شرح لكيفية اختبارها وتشغيلها عملياً، وأهم الاعتبارات لضمان النجاح الكامل.

## 1. نظام الإحصائيات والتقارير
الغرض من الإحصائيات هو تزويد الإدارة بنظرة عامة على أداء النظام وعدد المراجعين وتوزيعهم بين العيادات، بينما يوفر نظام التقارير سجلات يمكن تصديرها أو عرضها. يمكن تحقيق ذلك على النحو الآتي:

- **قاعدة بيانات:** استخدام جداول في ‎Supabase‎ لتسجيل كل عملية دخول أو خروج ووقت الانتظار والفحص. يمكن إضافة جدول للتقارير المجدولة.
- **وظائف backend:** إنشاء وظائف في مجلد ‎`api/`‎ أو ‎`supabase/functions`‎ تقوم بتجميع البيانات مثل عدد المراجعين لكل عيادة يومياً، معدل الانتظار، وعدد المخالفات (تجاوز مهلة الانتظار). يمكن لهذه الوظائف أن تُرجع بيانات بصيغة JSON أو ملفات ‎CSV‎ لتسهيل التحليل.
- **واجهة الإدارة:** في الواجهة الأمامية، تصميم صفحة Dashboards تعرض مخططات ورسوم بيانية (باستخدام ‎Chart.js‎ أو ‎ECharts‎) تعتمد على البيانات التي توفرها الوظائف الخلفية. يجب توفير خيارات لتصفية الفترات الزمنية وتصدير التقارير.

## 2. نظام الكيو (الدور)
نظام الدور هو قلب التطبيق، حيث ينظم دخول المراجعين إلى العيادات حسب الأولوية والزمن. المطلوب إدارة عدة عناصر:

### 2.1 إنشاء بنية البيانات
- لكل عيادة يوجد صف (Queue) مع قائمة مرتبة حسب رقم الدور. تُخزن هذه القائمة في جدول ‎`queue_entries`‎ مع الحقول التالية:
  - `clinic_id`: رقم العيادة.
  - `visitor_id`: معرف المراجع.
  - `position`: موقعه في الصف.
  - `status`: (منتظر، في العيادة، منتهٍ، متأخر، منقول لآخر الصف).
  - `assigned_at`: وقت تعيين الرقم.
  - `check_in_time`: وقت دخوله للعيادة (عند الضغط على "أيقونة الدخول").
- جدول آخر ‎`clinics`‎ يحدد وقت الخدمة المخصص لكل عيادة وعدد الدقائق المسموح بها (المهلة القصوى).

### 2.2 خوارزمية تعيين الدور
1. **البدء:** عند تسجيل الدخول عبر مسح الباركود في الاستقبال، يرسل التطبيق نوع الفحص المختار إلى وظيفة ‎API‎ في ‎`api/login.ts`‎ أو ‎`supabase/functions/login`‎【627421372308465†L360-L485】، وهي تقوم بالآتي:
   - اختيار العيادات المخصصة لهذا النوع من الفحص من جدول ‎`clinics`‎ مرتبة من الأقل ازدحاماً إلى الأكثر.
   - تعيين "المسار الديناميكي" للمراجع، أي قائمة العيادات التي يجب زيارتهـا بالترتيب. هذا الترتيب لا يتغير لاحقاً.
   - إضافة سجل في ‎`queue_entries`‎ للعيادة الأولى مع تحديد رقم الدور (أكبر رقم موجود + 1).
   - إرجاع بيانات الدور والمهلة المتاحة (5 دقائق).
2. **العد التنازلي:** في الواجهة الأمامية (صفحة "العيادة الحالية") يتم تشغيل عدٍّ تنازلي مدته 5 دقائق للمراجع حتى يصل إلى العيادة. يظهر العد التنازلي في الزاوية ويحدث كل ثانية. إذا انتهت 4 دقائق دون تسجيل دخول، تقوم خدمة الخلفية بنقل المراجع إلى نهاية الصف في هذه العيادة، ويتم تحديث واجهة المراجع بانتقاله لدور جديد وحساب مهلة جديدة.
3. **النداء الداخلي:** في لوحة العيادة، هناك خدمة داخلية لا تظهر للمراجعين تقوم بمتابعة الصف. إذا لم يسجل المراجع الحاضر في الصف دخوله خلال أول دقيقتين، يتم تمرير الدور للشخص التالي (يحصل التالي على الإشعار بالدخول)، وتستمر العملية كل دقيقتين حتى يسجل أحدهم دخوله. هذا المنطق يُنفّذ في خادم الخلفية على مستوى العيادة.
4. **تسجيل الدخول للعيادة:** عندما يضغط المراجع زر "الدخول للعيادة" (ويُدخل البن كود)، تُرسل الإشارة إلى API لتحديث حالة ‎`queue_entries`‎ إلى "في العيادة"، ويُوقف عدّ الدقيقتين. يُسمح له بمدة فحص قصوى (15 دقيقة مثلاً) قابلة للتعديل في شاشة الإدارة. عند الخروج، يضغط المراجع زرًا آخر أو يُسجّل خروجه تلقائياً إذا قام الطبيب بإدخال البن كود؛ وعندها يتم نقل الصف خطوة للأمام.
5. **المهلة القصوى:** إذا مرت 5 دقائق ولم يسجل المراجع دخوله، يغيّر النظام الحالة إلى "متأخر" ويضعه في نهاية الصف، كما يتم إرساله لإعادة حجز أو انتظار الدور مجدداً.

### 2.3 واجهة الاستخدام
- **تطبيق الاستقبال:** يحتوي على ماسح باركود يقوم بإنشاء رمز جلسة يُرسل إلى API لبدء العملية.
- **صفحة المراجع:** تظهر فيها العيادة الحالية مع العد التنازلي وزر "الدخول للعيادة" وزر "تم الانتهاء". عند الانتقال للعيادة التالية، تُحدّث الواجهة تلقائياً عبر نظام الإشعارات.
- **لوحة العيادة:** يتابع الطبيب أو الموظف قائمة الانتظار ويتحكم في البدء والتخطي وتمديد المهلة للمراجع عند الحاجة.

## 3. نظام الإشعارات
لتنبيه المراجعين عند اقتراب دورهم أو تغيّر حالتهم:

- **قنوات الإشعارات:** يمكن استخدام إشعارات الويب (Web Push Notifications) أو رسائل داخل التطبيق (in‑app). Supabase توفر قناة Realtime يمكن الاشتراك بها عبر ‎WebSockets‎ ليتلقى المراجع تحديثات مباشرة عند تغيير حالته أو اقتراب دوره.
- **تشغيل الإشعار:** عندما يتم تمرير الدور للشخص التالي أو عند نقل المراجع لنهاية الصف، تُرسل رسالة عبر Realtime إلى تطبيق المراجع. كذلك تُرسل إشعارات للمراجع عند اقتراب نهاية المهلة الممنوحة.
- **إدارة الصلاحيات:** يجب طلب موافقة المراجع على تلقي الإشعارات عند أول دخول للتطبيق، مع إمكانية إيقافها من الإعدادات.

## 4. نظام المسارات الديناميكية
يعتمد اختيار العيادات المناسبة على نوع الفحص. الخطوات:

- **تعريف الأنواع والعيادات:** في قاعدة البيانات، يوجد جدول لأنواع الفحوصات (مثلاً: عيون، قلب، أعصاب) وجدول آخر يحدد العيادات القادرة على إجراء كل فحص مع ترتيب الأولوية.
- **تحديد المسار:** عند تسجيل الدخول واختيار نوع الفحص، يقوم الخادم بإرجاع قائمة العيادات بالترتيب. يتم تخزين هذا المسار في جلسة المستخدم، ولا يجوز تغييره خلال الدورة الحالية لضمان الشفافية وعدم التلاعب.
- **التنقل:** بعد انتهاء المراجع من العيادة الأولى، يتم تحديث الحالة في ‎`queue_entries`‎ ويضاف إلى صف العيادة التالية تلقائياً.

## 5. نظام البن‑كود والباركود
لإدارة الدخول الآمن والتحقق من الهوية:

- **الباركود في الاستقبال:** يمكن توليد رموز QR أو Barcodes لكل مراجع أو لكل موعد. يقوم المراجع بمسح الرمز باستخدام هاتفه، فيُفتح التطبيق مباشرة ويُرسل رمز الجلسة إلى API لبدء إجراء "الكيو".
- **البن‑كود في العيادة:** عند الدخول أو الخروج من العيادة، يطلب النظام من المراجع إدخال ‎PIN‎ أو مسح رمز خاص لكي يُعرف أنه دخل فعلاً. هذه الخطوة توقف عدّ الدقيقتين وتبدأ مؤقت العيادة، وتُستخدم لتسجيل الخروج وإنهاء الدور.
- **الأمان:** يجب التأكد من أن الرموز تُستخدم مرة واحدة ولا يمكن مشاركتها، ويمكن ربطها بحساب المستخدم.

## 6. الربط بين الواجهة الأمامية والـ Back‑End
### 6.1 تصميم API
يمكن إنشاء مجموعة من نقاط النهاية (Endpoints) في ‎`api/`‎ للتعامل مع العمليات التالية:

| العملية | وصفها |
|---------|--------|
| **POST /start-session** | يُستدعى عند مسح الباركود ويُنشئ جلسة جديدة، يُحدد المسار الديناميكي ويُعين أول رقم في الدور. |
| **POST /queue/check-in** | يُستدعى عند الضغط على زر "الدخول للعيادة"؛ يحدّث حالة الصف ويوقف العد التنازلي. |
| **POST /queue/finish** | يُستدعى عند انتهاء الفحص؛ يزيل المراجع من الصف ويضيفه لعيادة أخرى إذا كانت ضمن المسار. |
| **GET /queue/status** | يُستخدم للاستعلام عن حالة المراجع الحالي، رقم دوره ووقته المتبقي. |
| **GET /stats/overview** | تُرجع إحصائيات مجمعة يومية أو أسبوعية للإدارة. |
| **GET /reports** | تُنتج تقارير بالتفاصيل مع إمكانية التصدير. |

### 6.2 تكامل مع الواجهة الأمامية
1. **المصادقة والجلسات:** بعد مسح الباركود، يحصل التطبيق على رمز جلسة يتم استخدامه في جميع الطلبات. يُخزن الرمز في ‎localStorage‎ أو ‎sessionStorage‎ ويوثّق الطلبات.
2. **التحديث اللحظي:** يستخدم التطبيق ‎WebSocket‎ أو ‎Supabase Realtime‎ للاشتراك في موضوعات الصف؛ عند أي تغيير يتلقى إشعاراً ويُحدث الواجهة تلقائياً.
3. **العد التنازلي:** يُشغّل عدّ بسيط في الجافاسكربت يأخذ الوقت المسموح به من الخادم. عند انتهاء الوقت، يُرسل طلب لنقل المراجع لنهاية الصف.

## 7. اختبارات التحقق من الميزات
للتأكد من أن المميزات تعمل بنسبة 95 % على الأقل، يجب إعداد سيناريوهات اختبار لكل ميزة:

- **الإحصائيات والتقارير:** إرسال بيانات وهمية للتأكد من صحة التجميع وعرضها في الواجهة الأمامية، ومقارنة النتائج مع المتوقع.
- **نظام الكيو:** محاكاة عدة مراجعين يدخلون في نفس الوقت، والتحقق من صحة ترتيب الصف ونقل المتأخرين، وسرعة النداء على الدور كل دقيقتين، وتطبيق المهلة القصوى 5 دقائق.
- **الإشعارات:** التحقق من وصول إشعار عند تغيير الدور أو اقتراب المهلة، وتجربة تشغيل/إيقاف الإشعارات من قبل المستخدم.
- **المسارات الديناميكية:** فحص أن اختيار نوع فحص مختلف يؤدي إلى مسار مختلف وتحديد العيادات بالترتيب الصحيح.
- **البن‑كود:** التأكد من أن إدخال البن‑كود يسمح للمراجع بالدخول وأن رمزًا خاطئاً يُرفض، كما يجب اختبار عملية تسجيل الخروج.

## 8. متابعة المشروع
بعد تنفيذ الخطوات أعلاه، يجب رفع هذا التقرير وملف الشيفرة المعدلة إلى مستودع **love** في GitHub وإكمال عملية الدمج. نظراً لقيود بيئة العمل الحالية لا يمكنني تنفيذ push أو دمج الكود بنفسي، لكن يمكنك استخدام الأوامر المذكورة في التقرير السابق لإعادة الشيفرة ثم إضافة هذا التقرير كملف (مثلاً `final_report.md`) والقيام بعملية commit وmerge يدويًا. تأكد من مراجعة الفرع المحمي بعد السماح بالدمج.

## خلاصة
تم وضع خطة مفصلة لتحقيق الترابط الكامل بين الواجهة الأمامية والخلفية، تشمل بناء نظام دور ديناميكي، نظام إشعارات، مسارات للعيادات، نظام بن‑كود، وإحصائيات وتقارير للإدارة. تعتمد هذه الخطة على تحديث بنية البيانات، تصميم ‎API‎ مناسب، واستخدام ميزات ‎Supabase Realtime‎ لمزامنة الحالة لحظة بلحظة. عند تنفيذ جميع الخطوات واختبارها وفقاً للسيناريوهات المقترحة، سيعمل النظام بكفاءة عالية ويحقق تجربة سلسة للمراجعين والعاملين في العيادات.
