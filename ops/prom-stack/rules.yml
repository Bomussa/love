# Prometheus Alert Rules (Add-only)
#
# Alert when 5xx error rate exceeds 2% (System SLO)
# Metrics are pushed from scripts/metrics/push-synthetic.mjs

groups:
  - name: api_slo_alerts
    interval: 15s
    rules:
      # Alert: High 5xx error rate (> 2%)
      - alert: HighErrorRate5xx
        expr: |
          (
            rate(http_requests_total{status="5xx"}[1m])
            /
            rate(http_requests_total[1m])
          ) > 0.02
        for: 30s
        labels:
          severity: critical
          team: platform
          slo: error_rate
        annotations:
          summary: "High 5xx error rate detected"
          description: "5xx error rate is {{ $value | humanizePercentage }} (threshold: 2%)"
          runbook: "https://github.com/Bomussa/love/blob/main/ops/README-OPS.md"

      # Alert: Total 5xx count threshold (alternative metric)
      - alert: High5xxCount
        expr: error_rate_5xx > 0.02
        for: 30s
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "5xx error rate metric exceeds threshold"
          description: "error_rate_5xx = {{ $value }} (threshold: 0.02 = 2%)"

      # Recording rule: Overall error rate
      - record: api:error_rate:1m
        expr: |
          (
            sum(rate(http_requests_total{status=~"5xx"}[1m]))
            /
            sum(rate(http_requests_total[1m]))
          )

      # Recording rule: Success rate (for dashboard)
      - record: api:success_rate:1m
        expr: |
          (
            sum(rate(http_requests_total{status=~"2xx"}[1m]))
            /
            sum(rate(http_requests_total[1m]))
          )

  - name: availability_alerts
    interval: 15s
    rules:
      # Alert: Service availability < 98%
      - alert: LowAvailability
        expr: api:success_rate:1m < 0.98
        for: 1m
        labels:
          severity: critical
          team: platform
          slo: availability
        annotations:
          summary: "Service availability below SLO"
          description: "Success rate is {{ $value | humanizePercentage }} (SLO: 98%)"
