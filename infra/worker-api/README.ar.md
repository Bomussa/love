# وكيل Cloudflare Worker لـ MMS (Proxy)

هذا المجلد يحتوي عامل Cloudflare Worker يعمل كـ Proxy ذكي لمسار `/api/*` مع:
- CORS مضبوط على `SITE_ORIGIN`
- حماية إدارة (Basic/JWT)
- معدل طلبات (Rate Limit) اختياري عبر KV
- كاش لـ GET لبعض المسارات العامة
- اختيار ديناميكي للـ Backend مع Fallback وجدولة `cron` كل 10 دقائق للتسخين/الفحص

## الإعداد السريع
1) حدّث `wrangler.toml`:
   - تأكد من `routes` و `zone_name` لنطاقك
   - ضع `SITE_ORIGIN` الصحيح (افتراضي: https://mmc-mms.com)
   - لا تستخدم workers.dev كـ Backend (لتجنّب إعادة التوجيه لنفس العامل)

2) ضع الأسرار في Cloudflare:
   - BACKEND_ORIGIN: عنوان الباكند الفعلي (مثلاً نفق Cloudflared رسمي أو أصل ثابت)
   - ADMIN_BASIC_USER/ADMIN_BASIC_PASS (اختياري)
   - JWT_SECRET (اختياري)

يمكن استعمال السكربت التالي للمساعدة على ويندوز:
```
tools\set-worker-secrets.ps1
```

3) النشر:
```
npx wrangler deploy
```

4) فحص الصحة من شبكة غير محجوبة (FortiGuard قد يحجب نطاق جديد):
```
tools\run-health.ps1 -ProjectDir infra -ApiOrigin https://mmc-mms.com/api
```

إن كانت شبكتك الداخلية تحجب `api.mmc-mms.com`، استخدم المسار البديل `https://mmc-mms.com/api` للتحقق.

## ملاحظات FortiGuard
- في حال ظهور "Newly Registered Domain"، ستظهر 403 في التقارير حتى يُعاد تصنيف النطاق. استخدم المسار البديل على النطاق الرئيسي `/api/*` مؤقتًا.
- يمكنك طلب إعادة تصنيف من Fortinet عبر الرابط الظاهر في صفحة الحجب.

## متغيرات مهمة
- SITE_ORIGIN: أصل الواجهة (CORS)
- BACKEND_ORIGIN (secret): مسار الباكند النشط
- PRIMARY_ORIGIN/SECONDARY_ORIGIN: مسارات بديلة غير سرّية
- FALLBACK_ORIGIN: لا تستخدم workers.dev هنا للباكند

## اختبار محلي/خارجي
- استعمل `infra/generate-health-status.js` لتوليد `HEALTH_STATUS.md` وقراءة الوضع.
- استعمل `infra/test-bypass.js` لتجريب المسارين (`api.` و`/api`).

Generated by Copilot
