/**
 * Smart Origin Switcher v1.0
 * ÙŠØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ø© Ù…Ø³Ø§Ø±Ø§Øª Backend ÙˆÙŠØ­Ø¯Ù‘Ø« Ø³Ø± BACKEND_ORIGIN Ù„Ù„Ù€ Worker ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.
 */
import fs from 'node:fs'
import { spawnSync } from 'node:child_process'

const configFile = new URL('./origin-config.json', import.meta.url).pathname
const healthPath = '/api/health'
// Ø­Ø¯Ù‘Ø« workers.dev Ù„Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„ÙØ¹Ù„ÙŠ
// Ù„Ø§ ØªØ³ØªØ®Ø¯Ù… workers.dev ÙƒØ£ØµÙ„ Backend Ø­ØªÙ‰ Ù„Ø§ ÙŠØ­Ø¯Ø« Proxy Ø¥Ù„Ù‰ Ù†ÙØ³Ù‡
// Candidates MUST be true backend origins (not the Worker route itself) to avoid proxy recursion.
const origins = [
  'https://app.mmc-mms.com'
]

async function checkOrigin(base) {
  try {
    const ctl = new AbortController()
    const t = setTimeout(() => ctl.abort('timeout'), 5000)
    const res = await fetch(base.replace(/\/$/, '') + healthPath, { method: 'GET', signal: ctl.signal })
    clearTimeout(t)
    if (!res.ok) return false
    try {
      const j = await res.clone().json()
      return j?.ok === true || j?.status === 'up' || j?.backend === 'up'
    } catch {
      return true
    }
  } catch {
    return false
  }
}

async function run() {
  for (const o of origins) {
    const ok = await checkOrigin(o)
    if (ok) {
      console.log('âœ… Active origin:', o)
      fs.writeFileSync(configFile, JSON.stringify({ activeOrigin: o, updated: new Date().toISOString() }, null, 2))
      // Ù†Ø³ØªØ®Ø¯Ù… wrangler secret put Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø±
      // Ù…Ù„Ø§Ø­Ø¸Ø©: wrangler ÙŠØªØ·Ù„Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù‚ÙŠÙ…Ø© Ù…Ù† stdin
      const put = spawnSync('npx', ['wrangler', 'secret', 'put', 'BACKEND_ORIGIN'], { input: o + '\n', stdio: ['pipe', 'inherit', 'inherit'] })
      if (put.status !== 0) process.exit(put.status ?? 1)
      console.log('ğŸ”„ Worker BACKEND_ORIGIN updated')
      return
    }
  }
  console.error('âŒ No reachable origin. Retrying later...')
  process.exit(1)
}

run()

// Generated by Copilot