name: Deploy to Vercel + Post-deploy Healthcheck

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      url:
        description: 'Optional override deployed URL'
        required: false
        default: ''

permissions:
  contents: read
  deployments: write
  issues: write

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Check if Vercel secrets are present
        id: check_secrets
        run: |
          if [ -n "${{ secrets.VERCEL_TOKEN }}" ] && [ -n "${{ secrets.VERCEL_ORG_ID }}" ] && [ -n "${{ secrets.VERCEL_PROJECT_ID }}" ]; then
            echo "secrets_present=true" >> $GITHUB_OUTPUT
            echo "✅ All Vercel secrets are present"
          else
            echo "secrets_present=false" >> $GITHUB_OUTPUT
            echo "⚠️ Vercel secrets are missing - will skip deploy"
          fi

      - name: Deploy to Vercel (Production)
        id: vercel
        if: steps.check_secrets.outputs.secrets_present == 'true'
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-args: '--prod'
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./

      - name: Resolve deployed URL
        id: resolve_url
        run: |
          # Priority: workflow_dispatch input > vercel preview URL > GH_PATH > DEPLOY_URL
          url="${{ github.event.inputs.url }}"
          if [ -z "$url" ]; then url="${{ steps.vercel.outputs.preview-url }}"; fi
          if [ -z "$url" ]; then url="${{ secrets.GH_PATH }}"; fi
          if [ -z "$url" ]; then url="${{ secrets.DEPLOY_URL }}"; fi
          
          if [ -z "$url" ]; then
            echo "❌ No DEPLOY_URL could be resolved"
            exit 1
          fi
          
          echo "DEPLOY_URL=$url" >> $GITHUB_ENV
          echo "✅ Resolved DEPLOY_URL=$url"

      - name: Post-deploy healthcheck
        env:
          DEPLOY_URL: ${{ env.DEPLOY_URL }}
        run: |
          echo "Running healthcheck against: $DEPLOY_URL"
          node scripts/test/vercel-health-check.js

      - name: Success notification (fallback Issue)
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const repo = `${context.repo.owner}/${context.repo.repo}`;
            const url = process.env.DEPLOY_URL || 'N/A';
            const deployStatus = '${{ steps.check_secrets.outputs.secrets_present }}' === 'true' ? 'deployed' : 'skipped (no secrets)';
            const body = [
              'تم إنجاز النشر بنجاح بنسبة 100% بعد اجتياز الفحوصات.',
              `- Repository: ${repo}`,
              `- URL: ${url}`,
              `- Deploy Status: ${deployStatus}`,
              `- Run: ${context.runId}`
            ].join('\n');
            await github.rest.issues.create({ 
              owner: context.repo.owner, 
              repo: context.repo.repo, 
              title: 'نجاح النشر — 100%', 
              body, 
              labels: ['deployment-success'] 
            });

