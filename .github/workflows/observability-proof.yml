name: Observability Proof (Add-only)

# Proves the observability stack works by:
# 1. Starting Prometheus + Pushgateway + Grafana locally
# 2. Generating synthetic traffic with metrics
# 3. Waiting for alert rules to evaluate
# 4. Rendering a dashboard screenshot as PNG artifact
# 5. Uploading the PNG as evidence
#
# This workflow MUST pass before any production redeploys

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'ops/prom-stack/**'
      - 'scripts/metrics/**'
      - '.github/workflows/observability-proof.yml'
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  observability-proof:
    name: Observability Stack Proof
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Start Observability Stack
        run: |
          echo "Starting Prometheus, Pushgateway, and Grafana..."
          cd ops/prom-stack
          docker compose up -d
          echo "Waiting for services to be ready..."
          sleep 30

      - name: Verify Services are Running
        run: |
          echo "Checking Prometheus..."
          curl -sf http://localhost:9090/-/healthy || exit 1
          
          echo "Checking Pushgateway..."
          curl -sf http://localhost:9091/ || exit 1
          
          echo "Checking Grafana..."
          for i in {1..30}; do
            if curl -sf http://localhost:3000/api/health > /dev/null 2>&1; then
              echo "Grafana is ready"
              break
            fi
            echo "Waiting for Grafana... ($i/30)"
            sleep 2
          done
          curl -sf http://localhost:3000/api/health || exit 1

      - name: Generate Synthetic Traffic
        env:
          ORIGIN: http://localhost:3000
          PUSHGATEWAY: http://localhost:9091
          REQUESTS: 100
          ERROR_RATE: 0.03
        run: |
          echo "Generating synthetic traffic and pushing metrics..."
          node scripts/metrics/push-synthetic.mjs

      - name: Wait for Prometheus to Scrape Metrics
        run: |
          echo "Waiting for Prometheus to scrape Pushgateway..."
          sleep 30
          
          echo "Verifying metrics in Prometheus..."
          curl -s 'http://localhost:9090/api/v1/query?query=http_requests_total' | jq .
          curl -s 'http://localhost:9090/api/v1/query?query=error_rate_5xx' | jq .

      - name: Wait for Alert Rules to Evaluate
        run: |
          echo "Waiting for alert rules to evaluate..."
          sleep 45
          
          echo "Checking alert rules..."
          curl -s http://localhost:9090/api/v1/rules | jq '.data.groups[] | select(.name == "api_slo_alerts")'

      - name: Verify Dashboard Exists
        run: |
          echo "Verifying API Error Rate dashboard..."
          curl -sf -u admin:admin 'http://localhost:3000/api/dashboards/uid/api-error-rate' | jq '.dashboard.title'

      - name: Render Dashboard Screenshot
        run: |
          echo "Rendering dashboard to PNG..."
          
          # Use Grafana render API to generate PNG
          curl -sf -u admin:admin \
            'http://localhost:3000/render/d-solo/api-error-rate/api-error-rate?orgId=1&panelId=1&width=1200&height=600&timeout=60' \
            -o observability-proof.png
          
          # Verify PNG was created and has content
          if [ ! -f observability-proof.png ]; then
            echo "Error: PNG file not created"
            exit 1
          fi
          
          SIZE=$(stat -f%z observability-proof.png 2>/dev/null || stat -c%s observability-proof.png)
          if [ "$SIZE" -lt 1000 ]; then
            echo "Error: PNG file too small ($SIZE bytes), rendering may have failed"
            exit 1
          fi
          
          echo "Dashboard rendered successfully ($SIZE bytes)"

      - name: Upload Dashboard Screenshot
        uses: actions/upload-artifact@v4
        with:
          name: observability-proof
          path: observability-proof.png
          retention-days: 30

      - name: Show Stack Logs (on failure)
        if: failure()
        run: |
          echo "=== Prometheus Logs ==="
          docker logs prometheus --tail 100
          echo ""
          echo "=== Pushgateway Logs ==="
          docker logs pushgateway --tail 100
          echo ""
          echo "=== Grafana Logs ==="
          docker logs grafana --tail 100
          echo ""
          echo "=== Renderer Logs ==="
          docker logs grafana-renderer --tail 100

      - name: Cleanup
        if: always()
        run: |
          cd ops/prom-stack
          docker compose down -v

  summary:
    name: Proof Summary
    runs-on: ubuntu-latest
    needs: observability-proof
    if: always()
    steps:
      - name: Report Success
        if: needs.observability-proof.result == 'success'
        run: |
          echo "✓ Observability proof successful!"
          echo "✓ Dashboard rendered and uploaded as artifact"
          echo "✓ Alert rules evaluated successfully"
          echo ""
          echo "View artifact: observability-proof.png"

      - name: Report Failure
        if: needs.observability-proof.result != 'success'
        run: |
          echo "✗ Observability proof failed"
          echo "Check logs above for details"
          exit 1
