name: Login Smoke (Production)
on:
  workflow_dispatch: {}
  push:
    branches: [ "main" ]
permissions:
  contents: read
env:
  PRODUCTION_URL: https://mmc-mms.com
jobs:
  login-smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Try common login endpoints (accept 200/401/403)
        run: |
          set -e
          URLS=(
            "$PRODUCTION_URL/api/v1/login"
            "$PRODUCTION_URL/api/login"
            "$PRODUCTION_URL/auth/login"
            "$PRODUCTION_URL/login"
            "$PRODUCTION_URL/api/v1/signin"
            "$PRODUCTION_URL/signin"
          )
          PASS=0
          for U in "${URLS[@]}"; do
            CODE=$(curl -sS -o /dev/null -w "%{http_code}" "$U" || echo "000")
            echo "=> $U -> $CODE"
            case "$CODE" in 200|401|403) PASS=1 ;; esac
          done
          if [ "$PASS" -ne 1 ]; then
            echo "No login endpoint returned 200/401/403"; exit 1
          fi
          echo "Login smoke passed"
      - name: CORS Preflight must not be 5xx
        run: |
          set -e
          TARGET="$PRODUCTION_URL/login"
          OPT=$(curl -sS -o /dev/null -w "%{http_code}" -X OPTIONS "$TARGET" \
            -H "Origin: $PRODUCTION_URL" \
            -H "Access-Control-Request-Method: POST" \
            -H "Access-Control-Request-Headers: Content-Type")
          case "$OPT" in 2*|3*|4*) echo "OPTIONS ok: $OPT" ;; *) echo "OPTIONS 5xx: $OPT"; exit 1 ;; esac
