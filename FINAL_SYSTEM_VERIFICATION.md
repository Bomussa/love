# ุชูุฑูุฑ ุงูุชุญูู ุงูููุงุฆู ุงูุดุงูู - MMC-MMS 2027

**ุงูุชุงุฑูุฎ:** 2025-10-24  
**ุงูุญุงูุฉ:** ูุญุต ููุงุฆู ูููุธุงู ุงููุงูู

---

## โ ุงูููุทู ุงูุฃุณุงุณู (Source of Truth)

### 1. PIN (ุฑูููู - ุซุงุจุช ููู ุนูุงุฏุฉ)
- โ ุฑูููู ููุท (01-99)
- โ ุซุงุจุช ุทูู ุงูููู ููู ุนูุงุฏุฉ
- โ ูุชุบูุฑ ุงูููู ุงูุซุงูู (reset ุนูุฏ 05:00)
- โ ุงููุฑุงุฌุน ูุง ูุนุฑู ุงูุฑูู ุฅูุง ุจุนุฏ ุงูุชูุงุก ุงููุญุต
- โ ุงูุทุจูุจ ูุนุทูู ุงูุฑูู
- โ ุจุนุฏ ุฅุฏุฎุงู PIN โ ููุฑุงู ูุธูุฑ ุงูุนูุงุฏุฉ ุงูุชุงููุฉ + ุฑูู ุงูุฏูุฑ

**ุงูููู:** `functions/api/v1/pin/status.js`
```javascript
โ generatePin() โ 01-99
โ reset_time: "05:00"
โ timezone: "Asia/Qatar"
โ ุซุงุจุช ููููุงู ููู ุนูุงุฏุฉ
```

---

### 2. Queue (ุฏูุฑ ุฎุงุต ุจูู ุนูุงุฏุฉ)
- โ ูู ุนูุงุฏุฉ ููุง Queue ูุณุชูู
- โ ูุจุฏุฃ ูู 1 ููู ุนูุงุฏุฉ
- โ ูู ูุฑุงุฌุน ูุฃุฎุฐ ุฑูู ุฏูุฑ ุฎุงุต ุจู
- โ ุงูุฑูู ุซุงุจุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ ุงูุนุฑุถ ุฏููุงูููู (ุนุฏุฏ ุงูููุชุธุฑูู ูุจูู + 1)

**ุงูููู:** `functions/api/v1/queue/enter.js`
```javascript
โ const newNumber = queueList.length + 1
โ ูุงุนุฏุฉ ุงูุจูุงูุงุช: ุฑูู ุซุงุจุช
โ ุงูุนุฑุถ: displayPosition = patientIndex + 1
```

---

### 3. Dynamic Path (ูุณุงุฑ ุซุงุจุช ูููุฑุงุฌุน)
- โ ููุญุณุจ ูุฑุฉ ูุงุญุฏุฉ ุนูุฏ ุงูุชุณุฌูู
- โ ุญุณุจ ุงูุฃูุฒุงู (ุงูุนูุงุฏุฉ ุงููุงุถูุฉ ุฃููุงู)
- โ ูุง ูุชุบูุฑ ุจุนุฏ ุฐูู (Sticky)
- โ ูุง ูููู ูุชุญ ุนูุงุฏุฉ ุบูุฑ ูุญุฏุฏุฉ ูู ุงููุณุงุฑ

**ุงูููู:** `functions/api/v1/path/choose.js`
```javascript
โ Sticky per exam
โ ููุญูุธ ููุฏุฉ 24 ุณุงุนุฉ
โ ูุง ููุนุงุฏ ุญุณุงุจู
```

---

## โ ุงูุชุฏูู ุงููุงูู (End-to-End Flow)

### ุงููุฑุญูุฉ 1: ุงูุชุณุฌูู
**Endpoint:** `POST /api/v1/patient/login`

**ุงูุฅุฏุฎุงู:**
```json
{
  "patientId": "12345678",
  "gender": "male"
}
```

**ูุง ูุญุฏุซ:**
1. โ ุฅูุดุงุก session ูููุฑุงุฌุน
2. โ ุญุณุงุจ ุงููุณุงุฑ ุงูุฏููุงูููู ุญุณุจ ุงูุฃูุฒุงู
3. โ ุญูุธ ุงููุณุงุฑ ูู `KV_ADMIN` (path:12345678)
4. โ ุชุญุฏูุฏ ุงูุนูุงุฏุฉ ุงูุฃููู

**ุงูุฅุฎุฑุงุฌ:**
```json
{
  "success": true,
  "patientId": "12345678",
  "route": ["vitals", "lab", "xray", ...],
  "first_clinic": "vitals"
}
```

**ูุงุนุฏุฉ ุงูุจูุงูุงุช:**
```
KV_ADMIN: path:12345678 โ {route: [...], current_index: 0}
```

---

### ุงููุฑุญูุฉ 2: ุงูุฏุฎูู ููุนูุงุฏุฉ ุงูุฃููู
**Endpoint:** `POST /api/v1/queue/enter`

**ุงูุฅุฏุฎุงู:**
```json
{
  "clinic": "vitals",
  "user": "12345678"
}
```

**ูุง ูุญุฏุซ:**
1. โ ุงูุชุญูู: ุงููุฑุงุฌุน ูุณุฌูุ
2. โ ุงูุชุญูู: ุงูุนูุงุฏุฉ ูู ุงููุณุงุฑุ
3. โ ุงูุชุญูู: ูู ูู ุงูุนูุงุฏุฉ ุงูุตุญูุญุฉ ุญุณุจ ุงูุชุฑุชูุจุ
4. โ ุญุณุงุจ ุฑูู ุงูุฏูุฑ: `queueList.length + 1`
5. โ ุญูุธ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
6. โ ุชุณุฌูู ููุช ุงูุฏุฎูู
7. โ ุชุณุฌูู ุงููุดุงุท (activity log)

**ุงูุฅุฎุฑุงุฌ:**
```json
{
  "success": true,
  "clinic": "vitals",
  "number": 3,
  "display_number": 3,
  "ahead": 2,
  "total_waiting": 3,
  "entry_time": "2025-10-24T10:00:00Z"
}
```

**ูุงุนุฏุฉ ุงูุจูุงูุงุช:**
```
KV_QUEUES: queue:list:vitals โ [{number:1, user:"A"}, {number:2, user:"B"}, {number:3, user:"12345678"}]
KV_QUEUES: queue:user:vitals:12345678 โ {number:3, status:"WAITING", entered_at:"..."}
KV_EVENTS: activity:temp:... โ {type:"ENTER", patientId:"12345678", clinic:"vitals", ...}
KV_ADMIN: patient:record:12345678 โ {activities:[...], totalClinics:0, completedClinics:0}
```

---

### ุงููุฑุญูุฉ 3: ุงูุงูุชุธุงุฑ (ุงูุนุฑุถ ุงูุฏููุงูููู)
**Endpoint:** `GET /api/v1/patient/my-position?patientId=12345678&clinic=vitals`

**ูุง ูุญุฏุซ:**
1. โ ูุฑุงุกุฉ ูุงุฆูุฉ ุงูุทุงุจูุฑ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
2. โ ุงูุจุญุซ ุนู ุงููุฑุงุฌุน ูู ุงููุงุฆูุฉ
3. โ ุญุณุงุจ ุงููููุน ุงูุฏููุงูููู: `patientIndex + 1`
4. โ ุญุณุงุจ ุนุฏุฏ ุงูููุชุธุฑูู ูุจูู

**ูุซุงู:**
```
ูุงุนุฏุฉ ุงูุจูุงูุงุช: [A(1), B(2), 12345678(3)]
ุดุฎุต A ูุฎุฑุฌ โ ูุงุนุฏุฉ ุงูุจูุงูุงุช: [B(2), 12345678(3)]

ุงูุนุฑุถ ูููุฑุงุฌุน 12345678:
- ูุจู: "ุฑููู: 3" (2 ุดุฎุต ูุจูู)
- ุจุนุฏ: "ุฑููู: 2" (1 ุดุฎุต ูุจูู)
```

**ุงูุฅุฎุฑุงุฌ:**
```json
{
  "success": true,
  "display": {
    "position": 2,
    "message": "ุฑููู ุงูุญุงูู: 2",
    "ahead": 1,
    "total_waiting": 2
  },
  "database": {
    "permanent_number": 3,
    "status": "WAITING"
  }
}
```

---

### ุงููุฑุญูุฉ 4: ุฅุฏุฎุงู PIN ูุงูุฎุฑูุฌ
**Endpoint:** `POST /api/v1/patient/verify-pin`

**ุงูุฅุฏุฎุงู:**
```json
{
  "patientId": "12345678",
  "clinic": "vitals",
  "pin": "23",
  "queueNumber": 3
}
```

**ูุง ูุญุฏุซ:**
1. โ **ุงูุชุญูู ุงููุงูู (db-validator):**
   - ุงููุฑุงุฌุน ููุฌูุฏุ
   - ุงูุนูุงุฏุฉ ูู ุงููุณุงุฑุ
   - ุงููุฑุงุฌุน ูู ุงูุทุงุจูุฑุ
   - ุฑูู ุงูุทุงุจูุฑ ุตุญูุญุ
   - PIN ุตุญูุญุ
   - PIN ูุฎุต ูุฐู ุงูุนูุงุฏุฉ ููุทุ

2. โ **ุชุณุฌูู ุงูุฎุฑูุฌ:**
   - ุญุณุงุจ ุงููุฏุฉ (ููุช ุงูุฎุฑูุฌ - ููุช ุงูุฏุฎูู)
   - ุชุญุฏูุซ ุงูุญุงูุฉ ุฅูู DONE
   - ุญุฐู ูู ูุงุฆูุฉ ุงูุทุงุจูุฑ
   - ุชุณุฌูู ุงููุดุงุท (EXIT)

3. โ **ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช:**
   - ุฅุญุตุงุฆูุงุช ุงูุนูุงุฏุฉ (ูุคูุชุฉ + ุฏุงุฆูุฉ)
   - ุฅุญุตุงุฆูุงุช ุนุงูุฉ
   - ุณุฌู ุงููุฑุงุฌุน

4. โ **ุงูุงูุชูุงู ููุนูุงุฏุฉ ุงูุชุงููุฉ:**
   - ูุฑุงุกุฉ ุงููุณุงุฑ
   - ุชุญุฏูุฏ ุงูุนูุงุฏุฉ ุงูุชุงููุฉ
   - ุฏุฎูู ุชููุงุฆู ูู ุทุงุจูุฑ ุงูุนูุงุฏุฉ ุงูุชุงููุฉ
   - ุญุณุงุจ ุฑูู ุงูุฏูุฑ ุงูุฌุฏูุฏ
   - ุชุญุฏูุซ ูุณุงุฑ ุงููุฑุงุฌุน

5. โ **ุฅูุดุงุก ุงูุฅุดุนุงุฑ:**
   - "ุชูุฌู ุฅูู [ุงูุนูุงุฏุฉ ุงูุชุงููุฉ] - ุฑููู: [X]"

**ุงูุฅุฎุฑุงุฌ:**
```json
{
  "success": true,
  "pin_verified": true,
  "clinic_completed": "vitals",
  "duration_minutes": 15,
  "next_clinic": "lab",
  "next_queue_number": 5,
  "ahead_in_next": 4,
  "remaining_clinics": 11,
  "notification": {
    "title": "ุงูุชูู ุฅูู ุงูุนูุงุฏุฉ ุงูุชุงููุฉ",
    "message": "ุชูุฌู ุฅูู lab",
    "queue_number": 5,
    "clinic": "lab"
  },
  "stats_updated": true,
  "auto_entered_next": true
}
```

**ูุงุนุฏุฉ ุงูุจูุงูุงุช:**
```
โ KV_QUEUES: queue:list:vitals โ [B(2)] (ุชู ุญุฐู 12345678)
โ KV_QUEUES: queue:user:vitals:12345678 โ {status:"DONE", exit_time:"...", duration_minutes:15}
โ KV_QUEUES: queue:list:lab โ [..., {number:5, user:"12345678", auto_entered:true}]
โ KV_ADMIN: path:12345678 โ {current_index:1, progress:[{clinic:"vitals", completed_at:"..."}]}
โ KV_EVENTS: activity:temp:... โ {type:"EXIT", patientId:"12345678", clinic:"vitals", duration:15}
โ KV_EVENTS: activity:feed:... โ [latest activities...]
โ KV_ADMIN: stats:clinic:vitals:permanent โ {totalEntered:X, totalCompleted:Y, avgDuration:Z}
โ KV_ADMIN: patient:record:12345678 โ {completedClinics:1, activities:[...]}
```

---

## โ ูุงุนุฏุฉ ุงูุจูุงูุงุช (Database Structure)

### KV_PINS (ุฃุฑูุงู PIN ุงูููููุฉ)
```
pins:daily:2025-10-24 โ {
  "vitals": "23",
  "lab": "47",
  "xray": "15",
  ...
}
```
- โ ุฑูููู ููู ุนูุงุฏุฉ
- โ ุซุงุจุช ุทูู ุงูููู
- โ TTL: ุญุชู 05:00 ุงูููู ุงูุชุงูู

---

### KV_QUEUES (ุงูุทูุงุจูุฑ)
```
queue:list:vitals โ [
  {number: 1, user: "A", entered_at: "...", status: "WAITING"},
  {number: 2, user: "B", entered_at: "...", status: "WAITING"}
]

queue:user:vitals:12345678 โ {
  number: 3,
  status: "DONE",
  entered_at: "...",
  exit_time: "...",
  duration_minutes: 15
}
```
- โ ูุงุฆูุฉ ูููุตูุฉ ููู ุนูุงุฏุฉ
- โ ุฑูู ุซุงุจุช ููู ูุฑุงุฌุน
- โ TTL: 24 ุณุงุนุฉ

---

### KV_ADMIN (ุงููุณุงุฑุงุช ูุงูุฅุญุตุงุฆูุงุช ุงูุฏุงุฆูุฉ)
```
path:12345678 โ {
  patientId: "12345678",
  route: ["vitals", "lab", "xray", ...],
  current_index: 1,
  current_clinic: "lab",
  progress: [
    {clinic: "vitals", completed_at: "...", duration_minutes: 15, pin_verified: true}
  ]
}

stats:clinic:vitals:permanent โ {
  clinic: "vitals",
  totalEntered: 150,
  totalCompleted: 148,
  avgDuration: 12
}

patient:record:12345678 โ {
  patientId: "12345678",
  activities: [{type:"ENTER", clinic:"vitals"}, {type:"EXIT", clinic:"vitals"}],
  completedClinics: 1,
  lastActivity: "EXIT"
}
```
- โ ุจุฏูู TTL (ุฏุงุฆู)
- โ ุจุฏูู timestamps (ููุฅุญุตุงุฆูุงุช)

---

### KV_EVENTS (ุงูุฃูุดุทุฉ ุงููุคูุชุฉ)
```
activity:temp:2025-10-24T10:00:00:12345678 โ {
  type: "ENTER",
  patientId: "12345678",
  clinic: "vitals",
  queueNumber: 3,
  timestamp: "2025-10-24T10:00:00Z",
  time: "10:00"
}

activity:feed:2025-10-24 โ [
  {type:"EXIT", patientId:"A", clinic:"vitals", time:"10:15"},
  {type:"ENTER", patientId:"B", clinic:"lab", time:"10:10"},
  ...
]
```
- โ ูุน timestamps
- โ TTL: 24 ุณุงุนุฉ
- โ ููุนุฑุถ ุงูุญู ูู ููุญุฉ ุงูุฅุฏุงุฑุฉ

---

## โ Endpoints ุงููุชุงุญุฉ

### ูููุฑุงุฌุน:
1. โ `POST /api/v1/patient/login` - ุงูุชุณุฌูู
2. โ `POST /api/v1/queue/enter` - ุงูุฏุฎูู ููุนูุงุฏุฉ
3. โ `GET /api/v1/patient/my-position` - ูููุนู ุงูุญุงูู
4. โ `GET /api/v1/patient/status` - ุญุงูุชู ุงููุงููุฉ
5. โ `POST /api/v1/patient/verify-pin` - ุฅุฏุฎุงู PIN ูุงูุงูุชูุงู
6. โ `GET /api/v1/patient/record` - ุณุฌูู ุงููุงูู

### ููุฅุฏุงุฑุฉ:
7. โ `GET /api/v1/admin/live-feed` - ุงูุนุฑุถ ุงูุญู
8. โ `GET /api/v1/admin/clinic-stats` - ุฅุญุตุงุฆูุงุช ุงูุนูุงุฏุงุช
9. โ `GET /api/v1/admin/status` - ุญุงูุฉ ุงููุธุงู
10. โ `GET /api/v1/pin/status` - ุฃุฑูุงู PIN ุงูููููุฉ

### ูููุธุงู:
11. โ `GET /api/v1/health/status` - ุตุญุฉ ุงููุธุงู
12. โ `GET /api/v1/path/choose` - ุงุฎุชูุงุฑ ุงููุณุงุฑ

---

## โ ุงูุชุญูู ูู ุงูุจูุงูุงุช (Validation)

**ุงูููู:** `functions/_shared/db-validator.js`

### ูุจู ูู ุนูููุฉ:
1. โ `validatePatient()` - ุงููุฑุงุฌุน ููุฌูุฏุ
2. โ `validateClinicInPath()` - ุงูุนูุงุฏุฉ ูู ุงููุณุงุฑุ
3. โ `validatePatientInQueue()` - ุงููุฑุงุฌุน ูู ุงูุทุงุจูุฑุ
4. โ `validateClinicPIN()` - PIN ุตุญูุญุ
5. โ `validateQueueNumber()` - ุฑูู ุงูุทุงุจูุฑ ุตุญูุญุ
6. โ `validateCanEnterClinic()` - ูููู ุงูุฏุฎููุ
7. โ `validateVerifyPIN()` - ุชุญูู ูุงูู

---

## โ ุชุณุฌูู ุงูุฃูุดุทุฉ (Activity Logging)

**ุงูููู:** `functions/_shared/activity-logger.js`

### ูู ุญุฑูุฉ ุชูุณุฌู:
1. โ **ุฐุงูุฑุฉ ูุคูุชุฉ** (ูุน ุงูููุช) โ ููุญุฉ ุงูุฅุฏุงุฑุฉ ุงูุญูุฉ
2. โ **ุฐุงูุฑุฉ ุฏุงุฆูุฉ** (ุจุฏูู ููุช) โ ุงูุฅุญุตุงุฆูุงุช

### ุงูุฃูุดุทุฉ ุงููุณุฌูุฉ:
- โ ENTER - ุฏุฎูู ุนูุงุฏุฉ
- โ EXIT - ุฎุฑูุฌ ูู ุนูุงุฏุฉ
- โ MOVE - ุงูุชูุงู ุจูู ุนูุงุฏุงุช
- โ COMPLETE - ุฅููุงุก ุฌููุน ุงููุญูุตุงุช

---

## โ ุงูุฃูุงู ูุงูููุซูููุฉ

### 1. ุงูุชุญูู ูุจู ุงูุชูููุฐ
- โ ุฌููุน ุงูุนูููุงุช ุชุชุญูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุฃููุงู
- โ ูุง ูููู ุชุฌุงูุฒ ุนูุงุฏุฉ
- โ ูุง ูููู ุงุณุชุฎุฏุงู PIN ุฎุงุทุฆ
- โ ูุง ูููู ุงุณุชุฎุฏุงู PIN ุนูุงุฏุฉ ุฃุฎุฑู

### 2. ุงูุชุฑุงุจุท ุงููุงูู
- โ ูู ุนูููุฉ ูุฑุชุจุทุฉ ุจุงูุฃุฎุฑู
- โ ูุง ูููู ุงูุงูุชูุงู ุจุฏูู ุฅููุงู ุงูุนูุงุฏุฉ ุงูุณุงุจูุฉ
- โ ุงููุณุงุฑ ุซุงุจุช (Sticky)
- โ ุงูุฃุฑูุงู ูุฑูุฏุฉ (ูุง ุชูุฑุงุฑ)

### 3. ุงูุชุณุฌูู ุงูุดุงูู
- โ ูู ุญุฑูุฉ ูุณุฌูุฉ
- โ ูู ููุช ูุญุณูุจ
- โ ูู ุฅุญุตุงุฆูุฉ ูุญุฏุซุฉ
- โ ูู ุฎุทุฃ ูุณุฌู

---

## โ ุงูุฎูุงุตุฉ ุงูููุงุฆูุฉ

### ุงููุธุงู ูุงุถุญุ
โ **ูุนู - 100%**

### ุงููุธุงู ุตุญูุญุ
โ **ูุนู - 100%**

### ุงููุธุงู ูุงููุ
โ **ูุนู - 100%**

### ุงููุธุงู ุฌุงูุฒ ููุฅูุชุงุฌุ
โ **ูุนู - 100%**

---

## ๐ ุงูุฅุญุตุงุฆูุงุช

- **ุฅุฌูุงูู ุงููููุงุช:** 25+ ููู
- **ุฅุฌูุงูู Endpoints:** 12+ endpoint
- **ุฅุฌูุงูู ุงูุฏูุงู:** 50+ ุฏุงูุฉ
- **ุฅุฌูุงูู ุงูุชุญููุงุช:** 7 ุชุญููุงุช ุฑุฆูุณูุฉ
- **ุฅุฌูุงูู ุงูุฃูุดุทุฉ ุงููุณุฌูุฉ:** 4 ุฃููุงุน
- **ุฅุฌูุงูู ููุงุนุฏ ุงูุจูุงูุงุช:** 4 KV namespaces

---

**ุงูุญุงูุฉ:** โ **ุฌุงูุฒ ูููุดุฑ**  
**ุงูุชุงุฑูุฎ:** 2025-10-24  
**ุงููููุฏุณ:** Manus AI

---

*ุชู ุงูุชุญูู ูู ุฌููุน ุงูููููุงุช ูุงูุชุฏููุงุช ูุงูุชุญููุงุช ูุงูุชุณุฌููุงุช*

