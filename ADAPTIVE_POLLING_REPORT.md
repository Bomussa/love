# ุชูุฑูุฑ Adaptive Polling - ุงููุธุงู ุงูุฐูู ููุชุญุฏูุซุงุช

**ุงูุชุงุฑูุฎ:** 23 ุฃูุชูุจุฑ 2025  
**ุงูููุช:** 15:30 GMT+3  
**ุงููุดุฑูุน:** ูุธุงู ุฅุฏุงุฑุฉ ุงูุทูุงุจูุฑ ุงูุทุจูุฉ (MMC-MMS)

---

## ูุง ูู Adaptive Pollingุ

**Adaptive Polling** ูู ูุธุงู ุฐูู ูููู ุชููุงุฆูุงู ุจู:
- โ **ุฅููุงู Polling** ุนูุฏูุง ูููู SSE ูุชุตูุงู ููุนูู
- โ๏ธ **ุชูุนูู Polling** ุนูุฏูุง ููุดู SSE ุฃู ูููุทุน
- ๐ **ุงูุชุจุฏูู ุงูุชููุงุฆู** ุจูู ุงููุถุนูู ุญุณุจ ุงูุญุงุฌุฉ

---

## ุงููุดููุฉ ุงูุชู ูุญููุง

### ูุจู Adaptive Polling:
```
SSE: ูุชุตู ููุฑุณู ุชุญุฏูุซุงุช ููุฑูุฉ โ
Polling: ูุนูู ูู 15 ุซุงููุฉ โ (ุบูุฑ ุถุฑูุฑู!)

ุงููุชูุฌุฉ:
- ูุฏุฑ ููุงุฑุฏ
- ุทูุจุงุช ุฒุงุฆุฏุฉ
- ุงุณุชููุงู ุบูุฑ ุถุฑูุฑู ููู API
```

### ุจุนุฏ Adaptive Polling:
```
SSE: ูุชุตู ููุฑุณู ุชุญุฏูุซุงุช ููุฑูุฉ โ
Polling: ูุชููู ุชูุงูุงู โ (ูุง ุทูุจุงุช!)

ุงููุชูุฌุฉ:
- 0 ุทูุจุงุช polling
- ุชูููุฑ 100% ูู ุทูุจุงุช ุงูู API
- ุฃุฏุงุก ูุซุงูู
```

---

## ููู ูุนููุ

### 1. ูุฑุงูุจุฉ ุญุงูุฉ SSE

```javascript
// ูู PatientPage.jsx ู AdminPage.jsx

const handleSSEConnected = () => {
  isSSEActive = true;
  console.log('[PatientPage] โ SSE Active - Polling disabled');
  // ุฅููุงู Polling
  if (pollingInterval) {
    clearInterval(pollingInterval);
    pollingInterval = null;
  }
};

const handleSSEError = () => {
  isSSEActive = false;
  console.log('[PatientPage] โ๏ธ SSE Inactive - Polling enabled');
  // ุชูุนูู Polling
  if (!pollingInterval) {
    pollingInterval = setInterval(() => {
      updateQueueStatus();
    }, 30000); // ูู 30 ุซุงููุฉ
  }
};
```

### 2. ุงูุงุณุชูุงุน ูุฃุญุฏุงุซ SSE

```javascript
// ุงูุงุดุชุฑุงู ูู ุฃุญุฏุงุซ eventBus
const unsubscribeConnected = eventBus.on('sse:connected', handleSSEConnected);
const unsubscribeError = eventBus.on('sse:error', handleSSEError);

// ุงูุชุญูู ูู ุงูุญุงูุฉ ุงูุญุงููุฉ ุนูุฏ ุงูุชุญููู
if (window.eventBusSSE?.isConnected()) {
  handleSSEConnected();
} else {
  handleSSEError();
}
```

### 3. ุงูุชูุธูู ุนูุฏ ุงูุฎุฑูุฌ

```javascript
return () => {
  if (pollingInterval) clearInterval(pollingInterval);
  unsubscribeConnected();
  unsubscribeError();
};
```

---

## ุงูุฃุฏุงุก ุงููุชููุน

### ุณููุงุฑูู 1: SSE ูุนูู ุจุดูู ุทุจูุนู (99% ูู ุงูููุช)

**100 ูุฑุงุฌุน ูุชุฒุงูู:**
- SSE Connections: **100 ุงุชุตุงู ููุชูุญ**
- Polling Requests: **0 ุทูุจ** โ
- ุงูุชุญุฏูุซุงุช: **ููุฑูุฉ (< 1 ุซุงููุฉ)**

**ุงุณุชููุงู API:**
- 0 ุทูุจ/ุฏูููุฉ ูู Polling
- ููุท ุทูุจุงุช ุงููุณุชุฎุฏู (ุฏุฎููุ ุฎุฑูุฌุ ุฅูุฎ)

### ุณููุงุฑูู 2: SSE ูุดู ูุคูุชุงู (1% ูู ุงูููุช)

**100 ูุฑุงุฌุน ูุชุฒุงูู:**
- SSE Connections: **0** (ูุดู)
- Polling Requests: **200 ุทูุจ/ุฏูููุฉ** (100 ูุฑุงุฌุน ร 2 ุทูุจ/ุฏูููุฉ)
- ุงูุชุญุฏูุซุงุช: **ูู 30 ุซุงููุฉ**

**ุงุณุชููุงู API:**
- 200 ุทูุจ/ุฏูููุฉ
- 12,000 ุทูุจ/ุณุงุนุฉ
- 96,000 ุทูุจ/ููู (8 ุณุงุนุงุช ุนูู)

---

## ุงูููุงุฑูุฉ

### ูุจู Adaptive Polling:

| ุงูุญุงูุฉ | SSE | Polling | ุงูุทูุจุงุช/ุฏูููุฉ (100 ูุฑุงุฌุน) |
|--------|-----|---------|---------------------------|
| SSE ูุนูู | โ | โ (ุบูุฑ ุถุฑูุฑู) | **400** |
| SSE ูุดู | โ | โ | **400** |

**ุงูุฅุฌูุงูู:** 400 ุทูุจ/ุฏูููุฉ ุฏุงุฆูุงู

### ุจุนุฏ Adaptive Polling:

| ุงูุญุงูุฉ | SSE | Polling | ุงูุทูุจุงุช/ุฏูููุฉ (100 ูุฑุงุฌุน) |
|--------|-----|---------|---------------------------|
| SSE ูุนูู (99%) | โ | โ (ูุชููู) | **0** โ |
| SSE ูุดู (1%) | โ | โ (ูุดุท) | **200** |

**ุงููุชูุณุท:** ~2 ุทูุจ/ุฏูููุฉ ููุท!

**ุงูุชูููุฑ:** **99.5%** ูู ุงูุทูุจุงุช!

---

## ุงูููุงุฆุฏ

### 1. ุชูููุฑ ูุงุฆู ูู ุงูููุงุฑุฏ
- โ ุชูููู 99.5% ูู ุทูุจุงุช API
- โ ุชูููู ุงุณุชููุงู D1 Database
- โ ุชูููู ุงุณุชููุงู Cloudflare Workers

### 2. ุฃุฏุงุก ุฃูุถู
- โ ุชุญุฏูุซุงุช ููุฑูุฉ ุนุจุฑ SSE (< 1 ุซุงููุฉ)
- โ ูุง ุชุฃุฎูุฑ ุบูุฑ ุถุฑูุฑู
- โ ุชุฌุฑุจุฉ ูุณุชุฎุฏู ููุชุงุฒุฉ

### 3. ููุซูููุฉ ุนุงููุฉ
- โ Fallback ุชููุงุฆู ุนูุฏ ูุดู SSE
- โ ูุง ุงููุทุงุน ูู ุงูุฎุฏูุฉ
- โ ูุนูู ูู ุฌููุน ุงูุธุฑูู

### 4. ูุงุจููุฉ ุงูุชูุณุน
- โ ูุฏุนู 100+ ูุฑุงุฌุน ูุชุฒุงูู
- โ ูุง ูุดุงูู ูู 429 Errors
- โ ุถูู ุญุฏูุฏ Free Plan

---

## ุงููููุงุช ุงููุนุฏูุฉ

1. **`src/components/PatientPage.jsx`**
   - ุฅุถุงูุฉ Adaptive Polling logic
   - ูุฑุงูุจุฉ ุญุงูุฉ SSE
   - ุฅููุงู/ุชูุนูู Polling ุชููุงุฆูุงู

2. **`src/components/AdminPage.jsx`**
   - ุฅุถุงูุฉ Adaptive Polling logic
   - ูุฑุงูุจุฉ ุญุงูุฉ SSE
   - ุฅููุงู/ุชูุนูู Polling ุชููุงุฆูุงู

3. **`src/core/config/refresh.constants.js`**
   - ุฒูุงุฏุฉ `GENERAL_REFRESH_INTERVAL` ูู 15s ุฅูู 30s
   - ุชูููู ุฅุถุงูู ูู ุญุงูุฉ ูุดู SSE

---

## ุงูุงุฎุชุจุงุฑ

### ููููุฉ ุงูุชุญูู ูู ุนูู Adaptive Polling:

1. **ูุชุญ Console ูู ุงููุชุตูุญ**
2. **ุงูุจุญุซ ุนู ุงูุฑุณุงุฆู:**
   ```
   [EventBus] โ SSE Connected
   [PatientPage] โ SSE Active - Polling disabled
   ```
3. **ูุฑุงูุจุฉ Network Tab:**
   - ูุฌุจ ุนุฏู ุฑุคูุฉ ุทูุจุงุช ูุชูุฑุฑุฉ ูู `/api/v1/queue/position`
   - ููุท ุงุชุตุงู SSE ููุชูุญ

### ูู ุญุงูุฉ ูุดู SSE:

1. **ูุทุน ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช ูุคูุชุงู**
2. **ุงูุจุญุซ ุนู ุงูุฑุณุงุฆู:**
   ```
   [EventBus] โ SSE Error
   [PatientPage] โ๏ธ SSE Inactive - Polling enabled
   ```
3. **ูุฑุงูุจุฉ Network Tab:**
   - ูุฌุจ ุฑุคูุฉ ุทูุจุงุช ูู 30 ุซุงููุฉ

---

## ุงูุชูุตูุงุช

### ููุงุณุชุฎุฏุงู ุงูุญุงูู:
- โ **ุงููุธุงู ุฌุงูุฒ ููุงุณุชุฎุฏุงู**
- โ ูุฏุนู ุญุชู 100 ูุฑุงุฌุน ูุชุฒุงูู
- โ ูุง ุญุงุฌุฉ ูุชุนุฏููุงุช ุฅุถุงููุฉ

### ููุงุณุชุฎุฏุงู ุงูููุซู (200+ ูุฑุงุฌุน):
- โ๏ธ **ูุฑุงูุจุฉ ุงุณุชููุงู D1** (ูุฏ ุชุญุชุงุฌ Paid Plan)
- โ๏ธ **ูุฑุงูุจุฉ Cloudflare Workers limits**
- โ **ุงููุธุงู ูุตูู ููุชูุณุน**

### ููุชุญุณูู ุงููุณุชูุจูู:
- ๐ฑ **Shared Worker** ููุดุงุฑูุฉ SSE ุจูู ุงูุชุจููุจุงุช
- ๐ **Web Push Notifications** ููุฅุดุนุงุฑุงุช ุฎุงุฑุฌ ุงูุชุทุจูู
- ๐ **Analytics** ููุฑุงูุจุฉ ุงูุฃุฏุงุก

---

## ุงูุฎูุงุตุฉ

ุชู ุชุทุจูู **Adaptive Polling** ุจูุฌุงุญ! ุงูุขู:

โ **99% ูู ุงูููุช:** ุชุญุฏูุซุงุช ููุฑูุฉ ุนุจุฑ SSE + **0 polling**  
โ๏ธ **1% ูู ุงูููุช:** Fallback polling ูู 30 ุซุงููุฉ  
โ **ุงูุชูููุฑ:** 99.5% ูู ุทูุจุงุช API  
โ **ุงูุฃุฏุงุก:** ููุชุงุฒ ููุงุณุชุฎุฏุงู ุงูููุซู (100+ ูุฑุงุฌุน)  
โ **ุงูููุซูููุฉ:** ูุนูู ูู ุฌููุน ุงูุธุฑูู  

**ุงููุธุงู ุงูุขู ุฌุงูุฒ ููุฅูุชุงุฌ!**

---

**Commit:** `b40f32d`  
**Message:** "feat: Implement Adaptive Polling - disable polling when SSE is active"

