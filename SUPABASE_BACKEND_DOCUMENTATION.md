# توثيق شامل للـ Backend الجديد (Supabase)

**التاريخ:** 6 نوفمبر 2025  
**المؤلف:** Manus AI  
**الحالة:** ✅ **مكتمل وجاهز للإنتاج**

---

## 1. ملخص البنية المعمارية

تم إعادة بناء الـ Backend بالكامل باستخدام **Supabase**، وهو يوفر قاعدة بيانات PostgreSQL، مصادقة، API فوري، Real-time subscriptions، وتخزين.

| المكون | التقنية | الدور |
|--------|---------|-------|
| **قاعدة البيانات** | PostgreSQL | تخزين جميع البيانات (العيادات، المرضى، الطوابير، الإشعارات) |
| **الـ API** | Supabase Auto-generated API | توفير واجهات RESTful للتفاعل مع قاعدة البيانات |
| **Real-time** | Supabase Realtime | توفير تحديثات لحظية للطوابير والإشعارات |
| **الأمان** | Row Level Security (RLS) | حماية البيانات على مستوى الصفوف |

---

## 2. بنية قاعدة البيانات (Database Schema)

تم إنشاء **7 جداول رئيسية** في قاعدة البيانات:

| الجدول | الوصف |
|--------------|--------|
| `clinics` | بيانات العيادات وأكواد PIN |
| `patients` | بيانات المرضى |
| `pathways` | المسارات الديناميكية للمرضى |
| `queues` | الطوابير الحالية لكل عيادة |
| `queue_history` | سجل الطوابير للتقارير والإحصائيات |
| `notifications` | إشعارات المرضى |
| `system_settings` | إعدادات النظام العامة |

**للتفاصيل الكاملة، انظر `supabase/schema.sql`**

---

## 3. واجهات API (Backend API)

تم بناء API محكم في `frontend/src/lib/supabase-backend-api.js` للتواصل مع Supabase.

### 3.1. إدارة المرضى

| الدالة | الوصف |
|--------------|--------|
| `patientLogin(id, gender)` | تسجيل دخول المريض أو إنشاء حساب جديد |

### 3.2. إدارة المسارات

| الدالة | الوصف |
|-----------------------|--------|
| `createPathway(patientId, gender)` | إنشاء مسار ديناميكي للمريض |
| `getPathway(patientId)` | استرجاع مسار المريض |
| `updatePathwayStep(patientId, step)` | تحديث خطوة المريض في المسار |

### 3.3. إدارة الطوابير

| الدالة | الوصف |
|-----------------------|--------|
| `enterQueue(clinicId, patientId)` | إدخال المريض إلى طابور العيادة |
| `getQueueStatus(clinicId)` | استرجاع حالة الطابور (المنتظرين، الدور الحالي) |
| `queueDone(clinicId, patientId, pin)` | إكمال دور المريض بعد التحقق من PIN |
| `getPatientPosition(clinicId, patientId)` | استرجاع موقع المريض في الطابور |

### 3.4. إدارة الإشعارات

| الدالة | الوصف |
|-----------------------|--------|
| `addNotification(patientId, message, type)` | إضافة إشعار جديد للمريض |
| `getNotifications(patientId, unreadOnly)` | استرجاع إشعارات المريض |
| `markNotificationRead(notificationId)` | تحديد إشعار كمقروء |

### 3.5. إدارة العيادات

| الدالة | الوصف |
|--------------|--------|
| `getClinics()` | استرجاع قائمة العيادات النشطة |
| `getPinStatus()` | استرجاع قائمة العيادات وأكواد PIN |

### 3.6. التقارير والإحصائيات

| الدالة | الوصف |
|----------------|--------|
| `getDailyReport(date)` | تقرير إحصائي يومي |
| `getAdminStatus()` | استرجاع حالة الإدارة العامة |

---

## 4. نظام Real-time

تم بناء نظام Real-time في `frontend/src/lib/realtime-service.js` باستخدام **Supabase Realtime**.

### 4.1. اشتراكات الطوابير

| الدالة | الوصف |
|-----------------------|--------|
| `subscribeToQueue(clinicId, callback)` | الاشتراك في تحديثات طابور عيادة معينة |
| `subscribeToAllQueues(callback)` | الاشتراك في تحديثات جميع الطوابير (للإدارة) |

### 4.2. اشتراكات الإشعارات

| الدالة | الوصف |
|-----------------------------|--------|
| `subscribeToNotifications(patientId, callback)` | الاشتراك في إشعارات مريض معين |

### 4.3. تتبع موقع المريض

| الدالة | الوصف |
|------------------------------------|--------|
| `trackPatientPosition(clinicId, patientId, callback)` | تتبع موقع المريض في الطابور بشكل لحظي |

### 4.4. لوحة تحكم الإدارة

| الدالة | الوصف |
|--------------------------------|--------|
| `subscribeToAdminDashboard(callback)` | الاشتراك في جميع تحديثات النظام للإدارة |

---

## 5. الأمان (Row Level Security)

تم تطبيق سياسات RLS على جميع الجداول لضمان:

- **الخصوصية:** لا يمكن للمريض رؤية بيانات مريض آخر.
- **الأمان:** لا يمكن تعديل البيانات إلا من خلال API.
- **الصلاحيات:** يمكن للإدارة رؤية جميع البيانات.

---

## 6. الاختبارات الشاملة

تم إجراء **7 اختبارات رئيسية** على الـ Backend الجديد، وجميعها **نجحت بنسبة 100%**:

| # | الاختبار | النتيجة |
|---|---------|--------|
| 1 | الاتصال بقاعدة البيانات | ✅ نجح |
| 2 | نظام العيادات وPIN | ✅ نجح |
| 3 | تسجيل المريض | ✅ نجح |
| 4 | المسار الديناميكي | ✅ نجح |
| 5 | نظام الطوابير | ✅ نجح |
| 6 | نظام الإشعارات | ✅ نجح |
| 7 | التقارير والإحصائيات | ✅ نجح |

**للتفاصيل الكاملة، انظر `test-supabase-backend.cjs`**

---

## 7. الخلاصة

تم بنجاح بناء Backend جديد ومحكم باستخدام Supabase، وهو جاهز للاستخدام في بيئة الإنتاج. يوفر النظام:

- **قاعدة بيانات قوية** (PostgreSQL)
- **API آمن** (RLS)
- **تحديثات لحظية** (Real-time)
- **قابلية للتوسع**

**✨ الـ Backend جاهز للإنتاج ✨**
