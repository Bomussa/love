{
  "database": "Supabase PostgreSQL",
  "migration_plan": {
    "source": "Cloudflare KV (Key-Value Store)",
    "target": "Supabase PostgreSQL (Relational Database)",
    "strategy": "تحويل من NoSQL إلى SQL مع الحفاظ على جميع البيانات"
  },
  "tables": [
    {
      "name": "users",
      "description": "جدول المستخدمين (Admin + Patients)",
      "priority": "عالية",
      "sql": "CREATE TABLE users (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  username VARCHAR(255) UNIQUE NOT NULL,\n  password_hash VARCHAR(255) NOT NULL,\n  role VARCHAR(50) NOT NULL CHECK (role IN ('admin', 'patient')),\n  full_name VARCHAR(255),\n  email VARCHAR(255),\n  phone VARCHAR(50),\n  created_at TIMESTAMPTZ DEFAULT NOW(),\n  updated_at TIMESTAMPTZ DEFAULT NOW(),\n  last_login TIMESTAMPTZ,\n  is_active BOOLEAN DEFAULT true\n);",
      "indexes": [
        "CREATE INDEX idx_users_username ON users(username);",
        "CREATE INDEX idx_users_role ON users(role);",
        "CREATE INDEX idx_users_created_at ON users(created_at);"
      ],
      "current_kv_keys": [
        "admin:credentials",
        "admin:sessions"
      ]
    },
    {
      "name": "sessions",
      "description": "جدول الجلسات (Sessions)",
      "priority": "عالية",
      "sql": "CREATE TABLE sessions (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  user_id UUID REFERENCES users(id) ON DELETE CASCADE,\n  token VARCHAR(255) UNIQUE NOT NULL,\n  ip_address INET,\n  user_agent TEXT,\n  created_at TIMESTAMPTZ DEFAULT NOW(),\n  expires_at TIMESTAMPTZ NOT NULL,\n  is_valid BOOLEAN DEFAULT true\n);",
      "indexes": [
        "CREATE INDEX idx_sessions_user_id ON sessions(user_id);",
        "CREATE INDEX idx_sessions_token ON sessions(token);",
        "CREATE INDEX idx_sessions_expires_at ON sessions(expires_at);"
      ],
      "current_kv_keys": [
        "session:*"
      ]
    },
    {
      "name": "clinics",
      "description": "جدول العيادات",
      "priority": "عالية",
      "sql": "CREATE TABLE clinics (\n  id VARCHAR(50) PRIMARY KEY,\n  name VARCHAR(255) NOT NULL,\n  name_ar VARCHAR(255) NOT NULL,\n  description TEXT,\n  pin_code VARCHAR(10),\n  pin_expires_at TIMESTAMPTZ,\n  is_active BOOLEAN DEFAULT true,\n  call_interval INTEGER DEFAULT 30,\n  created_at TIMESTAMPTZ DEFAULT NOW(),\n  updated_at TIMESTAMPTZ DEFAULT NOW()\n);",
      "indexes": [
        "CREATE INDEX idx_clinics_is_active ON clinics(is_active);",
        "CREATE INDEX idx_clinics_pin_expires_at ON clinics(pin_expires_at);"
      ],
      "current_kv_keys": [
        "pin:*",
        "clinic:*:settings"
      ]
    },
    {
      "name": "queue",
      "description": "جدول الطوابير (Queue)",
      "priority": "حرجة",
      "sql": "CREATE TABLE queue (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  patient_id VARCHAR(100) NOT NULL,\n  patient_name VARCHAR(255) NOT NULL,\n  clinic_id VARCHAR(50) REFERENCES clinics(id),\n  exam_type VARCHAR(100) NOT NULL,\n  status VARCHAR(50) NOT NULL CHECK (status IN ('waiting', 'called', 'in_progress', 'completed', 'cancelled')),\n  position INTEGER,\n  qr_code VARCHAR(255),\n  entered_at TIMESTAMPTZ DEFAULT NOW(),\n  called_at TIMESTAMPTZ,\n  completed_at TIMESTAMPTZ,\n  notes TEXT,\n  metadata JSONB\n);",
      "indexes": [
        "CREATE INDEX idx_queue_patient_id ON queue(patient_id);",
        "CREATE INDEX idx_queue_clinic_id ON queue(clinic_id);",
        "CREATE INDEX idx_queue_status ON queue(status);",
        "CREATE INDEX idx_queue_entered_at ON queue(entered_at);",
        "CREATE INDEX idx_queue_position ON queue(position);"
      ],
      "current_kv_keys": [
        "queue:*",
        "patient:*:position",
        "clinic:*:queue"
      ]
    },
    {
      "name": "notifications",
      "description": "جدول الإشعارات",
      "priority": "متوسطة",
      "sql": "CREATE TABLE notifications (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  patient_id VARCHAR(100),\n  clinic_id VARCHAR(50) REFERENCES clinics(id),\n  type VARCHAR(50) NOT NULL CHECK (type IN ('call', 'update', 'alert', 'info')),\n  title VARCHAR(255) NOT NULL,\n  message TEXT NOT NULL,\n  is_read BOOLEAN DEFAULT false,\n  sent_at TIMESTAMPTZ DEFAULT NOW(),\n  read_at TIMESTAMPTZ,\n  metadata JSONB\n);",
      "indexes": [
        "CREATE INDEX idx_notifications_patient_id ON notifications(patient_id);",
        "CREATE INDEX idx_notifications_clinic_id ON notifications(clinic_id);",
        "CREATE INDEX idx_notifications_is_read ON notifications(is_read);",
        "CREATE INDEX idx_notifications_sent_at ON notifications(sent_at);"
      ],
      "current_kv_keys": [
        "notifications:*"
      ]
    },
    {
      "name": "reports",
      "description": "جدول التقارير (يومية، أسبوعية، شهرية، سنوية)",
      "priority": "متوسطة",
      "sql": "CREATE TABLE reports (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  type VARCHAR(50) NOT NULL CHECK (type IN ('daily', 'weekly', 'monthly', 'yearly')),\n  clinic_id VARCHAR(50) REFERENCES clinics(id),\n  period_start DATE NOT NULL,\n  period_end DATE NOT NULL,\n  total_patients INTEGER DEFAULT 0,\n  completed_patients INTEGER DEFAULT 0,\n  cancelled_patients INTEGER DEFAULT 0,\n  average_wait_time INTEGER,\n  data JSONB,\n  generated_at TIMESTAMPTZ DEFAULT NOW()\n);",
      "indexes": [
        "CREATE INDEX idx_reports_type ON reports(type);",
        "CREATE INDEX idx_reports_clinic_id ON reports(clinic_id);",
        "CREATE INDEX idx_reports_period_start ON reports(period_start);",
        "CREATE INDEX idx_reports_generated_at ON reports(generated_at);"
      ],
      "current_kv_keys": [
        "report:daily:*",
        "report:weekly:*",
        "report:monthly:*",
        "stats:*"
      ]
    },
    {
      "name": "settings",
      "description": "جدول الإعدادات العامة للنظام",
      "priority": "منخفضة",
      "sql": "CREATE TABLE settings (\n  key VARCHAR(255) PRIMARY KEY,\n  value JSONB NOT NULL,\n  description TEXT,\n  category VARCHAR(100),\n  is_public BOOLEAN DEFAULT false,\n  updated_at TIMESTAMPTZ DEFAULT NOW(),\n  updated_by UUID REFERENCES users(id)\n);",
      "indexes": [
        "CREATE INDEX idx_settings_category ON settings(category);",
        "CREATE INDEX idx_settings_is_public ON settings(is_public);"
      ],
      "current_kv_keys": [
        "settings:*",
        "config:*"
      ]
    },
    {
      "name": "cache_logs",
      "description": "جدول سجلات الكاش والأحداث",
      "priority": "منخفضة",
      "sql": "CREATE TABLE cache_logs (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  event_type VARCHAR(100) NOT NULL,\n  resource_type VARCHAR(100),\n  resource_id VARCHAR(255),\n  action VARCHAR(50),\n  data JSONB,\n  created_at TIMESTAMPTZ DEFAULT NOW()\n);",
      "indexes": [
        "CREATE INDEX idx_cache_logs_event_type ON cache_logs(event_type);",
        "CREATE INDEX idx_cache_logs_resource_type ON cache_logs(resource_type);",
        "CREATE INDEX idx_cache_logs_created_at ON cache_logs(created_at);"
      ],
      "current_kv_keys": [
        "cache:*",
        "log:*"
      ]
    },
    {
      "name": "routes",
      "description": "جدول المسارات الديناميكية للفحوصات",
      "priority": "متوسطة",
      "sql": "CREATE TABLE routes (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  exam_type VARCHAR(100) NOT NULL,\n  route_name VARCHAR(255) NOT NULL,\n  clinics JSONB NOT NULL,\n  order_sequence INTEGER NOT NULL,\n  is_active BOOLEAN DEFAULT true,\n  created_at TIMESTAMPTZ DEFAULT NOW(),\n  updated_at TIMESTAMPTZ DEFAULT NOW()\n);",
      "indexes": [
        "CREATE INDEX idx_routes_exam_type ON routes(exam_type);",
        "CREATE INDEX idx_routes_is_active ON routes(is_active);"
      ],
      "current_kv_keys": [
        "route:*",
        "exam:*:path"
      ]
    }
  ],
  "migration_steps": [
    {
      "step": 1,
      "title": "إنشاء الجداول الأساسية",
      "tables": ["users", "sessions", "clinics"],
      "estimated_time": "10 دقائق"
    },
    {
      "step": 2,
      "title": "إنشاء جداول البيانات الرئيسية",
      "tables": ["queue", "notifications", "routes"],
      "estimated_time": "15 دقيقة"
    },
    {
      "step": 3,
      "title": "إنشاء جداول التقارير والإعدادات",
      "tables": ["reports", "settings", "cache_logs"],
      "estimated_time": "10 دقائق"
    },
    {
      "step": 4,
      "title": "نقل البيانات من Cloudflare KV",
      "description": "قراءة جميع المفاتيح من KV وتحويلها إلى صفوف في الجداول المناسبة",
      "estimated_time": "30-60 دقيقة"
    },
    {
      "step": 5,
      "title": "تحديث API Endpoints",
      "description": "تعديل جميع الـ 37 endpoint لاستخدام Supabase بدلاً من KV",
      "estimated_time": "2-3 ساعات"
    },
    {
      "step": 6,
      "title": "الاختبار والتحقق",
      "description": "اختبار جميع الوظائف والتأكد من عمل كل شيء بشكل صحيح",
      "estimated_time": "1-2 ساعة"
    }
  ],
  "risks": [
    {
      "risk": "فقدان البيانات أثناء النقل",
      "mitigation": "إنشاء نسخة احتياطية كاملة من KV قبل البدء",
      "severity": "عالية"
    },
    {
      "risk": "توقف الخدمة أثناء الترحيل",
      "mitigation": "تنفيذ الترحيل في وقت منخفض الاستخدام + استخدام Blue-Green Deployment",
      "severity": "متوسطة"
    },
    {
      "risk": "اختلاف في بنية البيانات",
      "mitigation": "اختبار شامل لجميع السيناريوهات قبل النشر",
      "severity": "متوسطة"
    },
    {
      "risk": "مشاكل في الأداء",
      "mitigation": "إضافة indexes مناسبة + استخدام connection pooling",
      "severity": "منخفضة"
    }
  ],
  "recommendations": [
    "استخدام Row Level Security (RLS) في Supabase لحماية البيانات",
    "إعداد Realtime subscriptions لتحديثات الطابور الفورية",
    "استخدام Supabase Edge Functions بدلاً من Cloudflare Workers تدريجياً",
    "إنشاء API wrapper layer للتبديل السلس بين KV و Supabase",
    "تفعيل Point-in-Time Recovery (PITR) للنسخ الاحتياطي التلقائي"
  ]
}

