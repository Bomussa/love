# توثيق: مسار تسجيل دخول المراجع (Patient Login Flow)

هذا المستند يوضح المتغيرات البيئية المطلوبة والخطوات اللازمة لتجهيز بيئة التطوير المحلية لميزة تسجيل دخول المراجع.

## 1. المتغيرات البيئية المطلوبة (Environment Variables)

تعتمد ميزة تسجيل دخول المراجع على الاتصال بخدمة Supabase للحصول على بيانات المسار (Pathway) والطوابير (Queues). يجب توفير المتغيرات التالية في ملف `.env.local` في مجلد `frontend/` أو في إعدادات بيئة النشر (مثل Vercel/Netlify).

| المتغير | الغرض | ملاحظات |
| :--- | :--- | :--- |
| `VITE_SUPABASE_URL` | عنوان URL لمشروع Supabase. | **مطلوب**. يمكن الحصول عليه من إعدادات مشروع Supabase. |
| `VITE_SUPABASE_ANON_KEY` | مفتاح Anon العام لمشروع Supabase. | **مطلوب**. يستخدم للوصول إلى البيانات غير الحساسة من الواجهة الأمامية. |
| `SUPABASE_SERVICE_ROLE_KEY` | مفتاح Service Role. | **مطلوب** إذا كان المشروع يستخدم وظائف خادم (Server Functions) تتطلب صلاحيات عالية (مثل إنشاء المسارات). يجب أن يكون سرياً ولا يُكشف للواجهة الأمامية. |

## 2. خطوات تجهيز بيئة التطوير المحلية

لتشغيل واختبار مسار تسجيل دخول المراجع محلياً، اتبع الخطوات التالية:

### الخطوة 1: تحديث ملف المتغيرات البيئية

1.  انتقل إلى جذر المشروع: `cd love`
2.  انسخ ملف الأمثلة إلى ملف الإعدادات المحلية في مجلد الواجهة الأمامية:
    ```bash
    cp .env.example frontend/.env.local
    ```
3.  افتح الملف `frontend/.env.local` واملأ القيم الحقيقية للمتغيرات:
    *   `VITE_SUPABASE_URL`
    *   `VITE_SUPABASE_ANON_KEY`
    *   `SUPABASE_SERVICE_ROLE_KEY` (إذا كان مطلوباً في بيئة التطوير)

### الخطوة 2: تشغيل المشروع

1.  انتقل إلى مجلد الواجهة الأمامية: `cd frontend`
2.  قم بتثبيت الاعتمادات (إذا لم تكن مثبتة بالفعل):
    ```bash
    pnpm install
    ```
3.  قم بتشغيل خادم التطوير:
    ```bash
    pnpm run dev
    ```

### الخطوة 3: اختبار مسار تسجيل الدخول

1.  افتح التطبيق في المتصفح.
2.  في شاشة تسجيل الدخول، أدخل أي **رقم شخصي** (Patient ID) و **النوع** (ذكر/أنثى).
    *   **ملاحظة:** لا يتطلب منطق `patientLogin` الحالي التحقق من قاعدة البيانات، بل يقوم بإنشاء جلسة مؤقتة.
3.  اضغط على زر **"تأكيد"**.
4.  يجب أن يتم توجيهك إلى شاشة **اختيار الفحص** (`ExamSelectionPage`).
5.  بعد اختيار الفحص، سيتم توجيهك إلى **صفحة المراجع** (`PatientPage`)، حيث يتم إنشاء المسار (Pathway) الخاص بك في Supabase.

## 3. معالجة الأخطاء الشائعة

| الخطأ | السبب المحتمل | الحل |
| :--- | :--- | :--- |
| **"Cannot coerce the result to a single JSON object"** | محاولة استرجاع صف واحد باستخدام `.single()` من Supabase، بينما الاستعلام أرجع صفر أو أكثر من صف واحد. | **تم الإصلاح:** تم تعديل استدعاءات Supabase في `lib/supabase-backend-api.js` لاستخدام `.maybeSingle()` أو التأكد من أن الاستعلام يضمن صفًا واحدًا فقط. |
| **"Missing Supabase environment variables"** | عدم توفير قيم لـ `VITE_SUPABASE_URL` أو `VITE_SUPABASE_ANON_KEY`. | تأكد من أن ملف `frontend/.env.local` يحتوي على القيم الصحيحة. |
| **فشل في الانتقال من صفحة الدخول** | فشل في الاتصال بـ Supabase أو خطأ في دالة `patientLogin`. | تحقق من اتصالك بالإنترنت، وتأكد من صحة مفاتيح Supabase، وراجع سجلات الـ Console في المتصفح بحثاً عن أخطاء في `lib/api-unified.js` أو `lib/supabase-backend-api.js`. |
