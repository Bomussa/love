# ملف ذاكرة المشروع — دليل شامل غير قابل للخطأ

التاريخ: 2025-10-15
المجلد الرئيسي للعمل: `الملازم غانم`

الغرض من هذا الملف: تذكير دائم بكل ما أنجزناه والخطة التشغيلية عند إغلاق/فتح VS Code، مع خطوات دقيقة لتشغيل وبناء ونشر النظام، وتتبّع الميزات الفعّالة وكيفية متابعتها.

---

## 1) ما الذي أنجزناه حتى الآن

- استعادة واجهة Vite + React وتعزيز عميل الـ API ليعمل في التطوير والإنتاج (مع تعدد قواعد الأصل والفشل الآمن لبعض المسارات في وضع التطوير فقط).
- إصلاح التنقل وتثبيت المنطق بدون راوتر (حالة عرض في `App.jsx`).
- دمج واختبار الثيمات الستة مع حفظها في localStorage، وتفعيل RTL عند العربية.
- توحيد هوية الأيقونات عبر التطبيق بنظام فئات CSS قياسي (أحجام/ألوان/هوامش منطقية).
- دعم إشعارات SSE ثنائية اللغة ديناميكياً (NEAR_TURN/YOUR_TURN) تتبدّل فور تبديل اللغة.
- تدفق العيادة الأولى: 
  - الدخول إلى العيادة بدون PIN عبر زر مخصص؛ الأيقونة تتحول للأخضر عند الدخول.
  - الخروج يتطلب PIN يساوي “رقم الدور الحقيقي” ثم يتم تعليم العيادة كمكتملة وفتح التالية تلقائياً.
- إنشاء مجلد تجميع نظيف باسم `الملازم غانم` يحوي الملفات الأساسية فقط للتشغيل والبناء والنشر.
- إضافة توثيق هيكلي: `README-STRUCTURE.md` يصف البنية والأقسام والوظائف.


## 2) كيف أتابع العمل بعد فتح VS Code

اتبع الخطوات بالتسلسل دون تخطي:

1. افتح VS Code على مجلد: `الملازم غانم`
2. ثبّت الاعتمادات:
   - PowerShell (موصى به):
     ```powershell
     npm ci
     # أو عند عدم توفر قفل الحزم:
     npm install
     ```
3. تشغيل وضع التطوير (واجهة فقط):
   ```powershell
   npm run dev
   ```
   - افتح المتصفح على العنوان المحلي الذي يطبعه Vite (عادة: http://localhost:5173).

4. إنتاج محلي (واجهة + سيرفر إنتاج إن وُجد):
   ```powershell
   npm run build
   npm start
   ```

5. قاعدة البيانات (اختياري لاحقاً):
   - إذا رغبت بتمكين PostgreSQL محلياً:
     ```powershell
     docker compose up -d
     ```
   - ثم فعّل الاتصال عبر `.env` (إن لزم) حسب `DEPLOYMENT_GUIDE.md`.

6. للتحقق السريع بعد التشغيل:
   - اللغة الافتراضية عربية؛ بدّل إلى الإنجليزية من زر اللغة وتأكد أن إشعارات “اقترب دورك/دورك الآن” تتغير فوراً.
   - في صفحة المراجع، جرّب زر “دخول العيادة” لأول عيادة، ثم للخروج أدخل PIN يساوي رقم الدور الحقيقي.


## 3) خريطة المشروع (في `الملازم غانم`)

- `src/`
  - `App.jsx`: نقطة التحكم بالتنقل، الثيمات، SSE ثنائي اللغة.
  - `components/PatientPage.jsx`: تدفق العيادة الأولى (دخول بدون PIN، خروج بـ PIN=رقم الدور).
  - بقية المكونات القياسية (LoginPage, ExamSelectionPage, AdminPage...).
- `public/`: `index.html`, الأصول والصور.
- `lib/` (داخل `src/`):
  - `api.js`: عميل API resilient + دوال `enterClinic`, `completeClinic`, `unlockStation` (للتحقق من PIN).
  - `i18n.js`: الترجمات العربية/الإنجليزية وتعيين RTL.
  - `enhanced-themes.js`, `utils.js`: الثيمات ومسارات العيادات.
- `dist_server/`: مسارات Express المترجمة (Queue/Pin/Route/Settings/Stats...).
- `config/`: `routeMap.json`، إعدادات المسارات.
- `data/`: ملفات JSON الدائمة (عند تمكين السيرفر).
- `deploy/`, `infra/`, `db/`, `theme/`, `tools/` (أدوات/سكربتات التشغيل والبناء والنشر).
- ملفات الجذر: `package.json`, `vite.config.js`, `tailwind.config.js`, `postcss.config.js`, `docker-compose.yml`, `README.md`, `README-deploy.md`, `DEPLOYMENT_GUIDE.md`, `start-mms.ps1`.


## 4) المسارات (API) المهمة للميزات الحالية

- الطابور Queue:
  - POST `/api/queue/enter` — دخول العيادة (يرجع رقم الدور الحقيقي `ticket`).
  - POST `/api/queue/complete` — إنهاء العيادة.
- الأرقام PIN:
  - POST `/api/pin/issue` — إصدار رقم.
  - POST `/api/pin/validate` — تحقق PIN (يستخدم للتأكد من الخروج).
- المسارات السريرية Route:
  - POST `/api/route/assign`, GET `/api/route/:visitId` (عند التمكين).
- الإشعارات SSE:
  - GET `/api/events` — أحداث لحظية NEAR_TURN/YOUR_TURN/STEP_DONE_NEXT.


## 5) ما الذي يجب تذكره عند أي تعديل

- العربية هي الافتراضية، لا تغيّر مفاتيح localStorage للألوان/اللغة.
- حافظ على RTL في العربية.
- حافظ على أسماء الثيمات وقيم الألوان الأساسية (8a1538, c9a54c) وفق الهوية.
- استخدم SSE بدل WebSockets؛ واترك المحاكاة للتطوير فقط.
- لا تضف اختبارات أو مجلدات غير أساسية إلى مجلد `الملازم غانم` كي يبقى نظيفاً.


## 6) مهام لاحقة (اختيارية)

- ربط الإشعارات بمصدر SSE الحقيقي بالكامل وإزالة أي محاكاة.
- توسيع شرط PIN عند الخروج ليشمل عيادات أخرى (حسب `routeMap.json`).
- تحسين تقسيم الشيفرة (code splitting) لتقليل حجم الحِزم.


## 7) إجراءات الطوارئ السريعة

- عند فشل البناء:
  - تأكد من Node 18+، احذف `node_modules` ثم:
    ```powershell
    npm ci
    npm run build
    ```
- عند تعطل السيرفر:
  - تحقق من سجلات `dist_server` والبيئة `.env` ووجود PostgreSQL إذا كانت الميزات مفعلة.
- عند مشاكل RTL/الثيم:
  - تحقق من `localStorage` (`selectedTheme`, `language`) ومن تطبيق CSS المولد عبر `enhanced-themes`.


## 8) سجل تغييرات مختصر

- 2025-10-15:
  - تجميع مشروع نظيف `الملازم غانم`.
  - تحديث SSE ليكون ثنائي اللغة ديناميكياً.
  - تنفيذ تدفق العيادة الأولى (دخول بدون PIN + خروج بـ PIN=رقم الدور).
  - توثيق هيكلي شامل.

— انتهى —
